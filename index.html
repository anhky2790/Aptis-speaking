<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Speaking Coach</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
        }
        .question-section {
            display: flex;
            flex-direction: column;
        }
        .timer {
            font-size: 1.5em;
            color: red;
            text-align: center;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .recordings {
            margin-top: 20px;
        }
        .recording-item {
            margin-bottom: 10px;
        }
        .settings {
            display: flex;
            justify-content: space-between;
        }
        select, input[type="range"] {
            margin: 0 10px;
        }
        .speed-controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        .speed-controls button {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>English Speaking Coach</h1>
        <p>B·∫£n ƒë·ªôc l·∫≠p ‚Äì Q&A, ƒë·∫øm ng∆∞·ª£c, ghi √¢m & ph√°t l·∫°i, transcript tr·ª±c ti·∫øp</p>

        <div class="section question-section">
            <label>Ch·ªß ƒë·ªÅ</label>
            <input type="text" id="topic" value="Sample Topic" readonly>

            <label>C√¢u h·ªèi</label>
            <textarea id="question">What is your favorite hobby and why?</textarea>

            <button id="playQuestion">üîä Play Question</button>

            <label>G·ª£i √Ω c√¢u tr·∫£ l·ªùi</label>
            <textarea id="suggestedAnswer">My favorite hobby is reading because it helps me relax and learn new things.</textarea>

            <button id="playSuggested">üîä Play Suggested Answer</button>

            <div class="timer" id="timer">00:30</div>

            <div class="controls">
                <button id="startRecording">üéôÔ∏è Start</button>
                <button id="stopRecording" disabled>‚èπ Stop</button>
                <button id="clearTranscript">üßπ Clear transcript</button>
                <button id="playLastRecording">‚èØÔ∏è Play last recording</button>
            </div>

            <p>Tip: B·∫°n tr·∫£ l·ªùi theo √Ω b·∫°n, kh√¥ng c·∫ßn ƒë·ªçc theo g·ª£i √Ω.</p>

            <label>T√¥i n√≥i (ghi theo th·ªùi gian th·ª±c)</label>
            <textarea id="transcript" readonly></textarea>
        </div>

        <div class="section settings">
            <div>
                <label>Voice</label>
                <select id="voiceSelect"></select>
            </div>
            <div>
                <label>T·ªëc ƒë·ªô</label>
                <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1">
                <span id="rateValue">1.0</span>
            </div>
            <div>
                <label>Cao ƒë·ªô</label>
                <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1">
                <span id="pitchValue">1.0</span>
            </div>
        </div>

        <div class="section recordings">
            <h3>B·∫£n ghi g·∫ßn ƒë√¢y</h3>
            <p>L∆∞u c·ª•c b·ªô trong phi√™n n√†y. B·∫°n c√≥ th·ªÉ t·∫£i v·ªÅ.</p>
            <div id="recordingList"></div>
        </div>

        <div class="speed-controls">
            <h3>T·ªëc ƒë·ªô ph√°t</h3>
            <button onclick="setPlaybackSpeed(0.75)">0.75√ó</button>
            <button onclick="setPlaybackSpeed(1.00)">1.00√ó</button>
            <button onclick="setPlaybackSpeed(1.25)">1.25√ó</button>
            <button onclick="setPlaybackSpeed(1.50)">1.50√ó</button>
            <button onclick="setPlaybackSpeed(2.00)">2.00√ó</button>
        </div>
    </div>

    <script>
        // Polyfills and compatibility checks
        if (!('speechSynthesis' in window)) {
            alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Speech Synthesis. Vui l√≤ng s·ª≠ d·ª•ng Chrome, Safari ho·∫∑c Edge.');
        }
        if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
            alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Speech Recognition. Vui l√≤ng s·ª≠ d·ª•ng Chrome ho·∫∑c Safari.');
        }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ghi √¢m. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p microphone.');
        }

        // Global variables
        let recognition;
        let mediaRecorder;
        let audioChunks = [];
        let recordings = []; // Array to store recorded audio blobs
        let currentAudio = null; // For playback
        let playbackSpeed = 1.0;
        let timerInterval;
        let timeLeft = 30; // Default 30 seconds
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        // Initialize Speech Synthesis
        const synth = window.speechSynthesis;
        let voices = [];
        function populateVoiceList() {
            voices = synth.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '';
            voices.forEach(voice => {
                if (voice.lang.startsWith('en')) { // English voices only
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.name;
                    voiceSelect.appendChild(option);
                }
            });
        }
        populateVoiceList();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateVoiceList;
        }

        // Update rate and pitch values
        document.getElementById('rate').addEventListener('input', e => {
            document.getElementById('rateValue').textContent = e.target.value;
        });
        document.getElementById('pitch').addEventListener('input', e => {
            document.getElementById('pitchValue').textContent = e.target.value;
        });

        // Play Question
        document.getElementById('playQuestion').addEventListener('click', () => {
            const text = document.getElementById('question').value;
            speak(text);
        });

        // Play Suggested Answer
        document.getElementById('playSuggested').addEventListener('click', () => {
            const text = document.getElementById('suggestedAnswer').value;
            speak(text);
        });

        // Speak function with settings
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            const selectedVoice = document.getElementById('voiceSelect').value;
            const voice = voices.find(v => v.name === selectedVoice);
            if (voice) utterance.voice = voice;
            utterance.rate = parseFloat(document.getElementById('rate').value);
            utterance.pitch = parseFloat(document.getElementById('pitch').value);
            synth.speak(utterance);
        }

        // Start Recording
        document.getElementById('startRecording').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' }); // Use webm for broader compatibility
                    recordings.push(blob);
                    updateRecordingList();
                };

                mediaRecorder.start();
                document.getElementById('startRecording').disabled = true;
                document.getElementById('stopRecording').disabled = false;

                // Start timer countdown
                timeLeft = 30;
                document.getElementById('timer').textContent = '00:30';
                timerInterval = setInterval(updateTimer, 1000);

                // Start speech recognition
                if (SpeechRecognition) {
                    recognition = new SpeechRecognition();
                    recognition.lang = 'en-US';
                    recognition.interimResults = true;
                    recognition.onresult = event => {
                        const transcript = Array.from(event.results)
                            .map(result => result[0].transcript)
                            .join('');
                        document.getElementById('transcript').value = transcript;
                    };
                    recognition.onerror = event => console.error('Speech recognition error', event);
                    recognition.start();
                }
            } catch (err) {
                console.error('Error accessing microphone', err);
                alert('Kh√¥ng th·ªÉ truy c·∫≠p microphone. Vui l√≤ng ki·ªÉm tra quy·ªÅn v√† th·ª≠ l·∫°i.');
            }
        });

        // Stop Recording
        document.getElementById('stopRecording').addEventListener('click', () => {
            if (mediaRecorder) mediaRecorder.stop();
            if (recognition) recognition.stop();
            clearInterval(timerInterval);
            document.getElementById('startRecording').disabled = false;
            document.getElementById('stopRecording').disabled = true;
        });

        // Clear Transcript
        document.getElementById('clearTranscript').addEventListener('click', () => {
            document.getElementById('transcript').value = '';
        });

        // Play Last Recording
        document.getElementById('playLastRecording').addEventListener('click', () => {
            if (recordings.length > 0) {
                const lastRecording = recordings[recordings.length - 1];
                if (currentAudio) currentAudio.pause();
                currentAudio = new Audio(URL.createObjectURL(lastRecording));
                currentAudio.playbackRate = playbackSpeed;
                currentAudio.play();
            } else {
                alert('Ch∆∞a c√≥ b·∫£n ghi n√†o.');
            }
        });

        // Update Timer
        function updateTimer() {
            timeLeft--;
            document.getElementById('timer').textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById('stopRecording').click(); // Auto stop when time up
            }
        }

        // Update Recording List
        function updateRecordingList() {
            const list = document.getElementById('recordingList');
            list.innerHTML = '';
            recordings.forEach((blob, index) => {
                const div = document.createElement('div');
                div.className = 'recording-item';
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = URL.createObjectURL(blob);
                const download = document.createElement('a');
                download.href = audio.src;
                download.download = `recording_${index + 1}.webm`;
                download.textContent = 'T·∫£i v·ªÅ';
                div.appendChild(audio);
                div.appendChild(download);
                list.appendChild(div);
            });
        }

        // Set Playback Speed
        function setPlaybackSpeed(speed) {
            playbackSpeed = speed;
            if (currentAudio) currentAudio.playbackRate = speed;
            // Optionally update UI to highlight selected speed
        }
    </script>
</body>
</html>